var TableList = $('#TableList').DataTable( {
    responsive: true,
    "columns": [
        { "data": "id" },
        { "data": "area" },
        { "data": "name" },
        { "data": "meals_count" },
        { "data": "operation" },
    ],
    "lengthMenu": [15, 25, 50, 100],
    "iDisplayLength": 15,
    "ajax": "/api/admin/list/restaurant", 
    "drawCallback": function (settings) {
        $("td, th").css({"vertical-align": "middle", "text-align": "center"});
        $('tr td:nth-child(3)').css('text-align', 'left');
        $('#updateTime').text(moment(new Date()).format('YYYY-MM-DD HH:mm:ss'));
    }
});
// new $.fn.dataTable.FixedHeader( TableList );
$("#TableList_filter").append("&emsp;<button class='btn btn-primary' id='add-btn'>新增餐廳</button>");

$(document).ready(function() {
    $('.selectpicker').selectpicker();
    update_referance();
});

function get_restaurant_details(id)
{
    ajax('get', '/api/restaurant/' + id, {}, function(a){
        if (!a.error)
        {
            const response = a.data;
            $('#edit_name').val(response.name);
            $('#edit_area').val(response.area);
            $('#edit_address').val(response.address);
            $('#edit_lat').val(response.lat);
            $('#edit_lng').val(response.lng);
            $('#edit_tel').val(response.tel);
            $('#edit_email').val(response.email);
            $('#edit_google_map_url').val(response.google_map_url);
            $('.save-btn').data('action', 'edit');
            $('.save-btn').data('id', response.id);
            $('.delete-btn').data('id', response.id);
            $('.delete-btn').show();
            $('#md-method').text('編輯');

            $('#meals-nav').show();
            $('#meals-list').empty();
            response.meals.forEach(function(item, index){
                $('#meals-list').append(`
                    <tr>
                        <td class="align-middle text-center ">${item.id}</td>
                        <td class="align-middle text-left">${item.name}</td>
                        <td class="align-middle">
                            <button class="btn btn-secondary edit-meal-btn" data-id="${item.id}"><i class='fas fa-cogs'></i></button>
                            <button class="btn btn-danger del-meal-btn" data-id="${item.id}"><i class='fas fa-solid fa-trash'></i></button>
                        </td>
                    </tr>
                `);
            });

            $('#_modal').modal({
                backdrop: 'static',
                keyboard: true,
                show: true
            });
        }
    });
}

function get_meal_detail(id)
{
    ajax('get', '/api/meals/' + id, {}, function(a){
        if (!a.error)
        {
            const response = a.data;
            console.log(response);
            $('#meal_name').val(response.name);
            $('#meal_price').val(response.price);
            $('#meal_category').val(response.category);
            $('#meal_calorie').val(response.calorie);
            $('#meal_description').val(response.description);
            $('#meal_category').selectpicker('refresh');
            $('.save-meals-btn').data('action', 'edit');
            $('.save-meals-btn').data('id', response.id);
            $('#meals-modal').modal({
                backdrop: 'static',
                keyboard: true,
                show: true
            });
        }
    });
}

function update_referance()
{
    ajax('get', '/api/category/list', {}, function(a){
        if (!a.error)
        {
            const response = a.data;
            console.log(response);
            $('#meal_category').empty();
            response.forEach(function(item, index){
                $('#meal_category').append(`<option value="${item.id}">${item.name}</option>`);
            });
            $('#meal_category').val(response[0].id);
            $('#meal_category').selectpicker('refresh');
        }
    });
}

$(document).on('click', '#add-btn', function(){
    $('.form-control').val('');
    $('.save-btn').data('action', 'add');
    $('#md-method').text('新增');
    $('.delete-btn').hide();
    $('#meals-nav').hide();
    $('#info-nav').click();
    $('#_modal').modal({
        backdrop: 'static',
        keyboard: true,
        show: true
    });
});

$(document).on('click', '.edit-btn', function(){
    get_restaurant_details($(this).data('id'));
});

$(document).on('click', '.save-btn', function(){
    const action = $(this).data('action');
    const id = $(this).data('id');
    const name = $('#edit_name').val();
    const area = $('#edit_area').val();
    const address = $('#edit_address').val();
    const lat = parseFloat($('#edit_lat').val()).toFixed(9);
    const lng = parseFloat($('#edit_lng').val()).toFixed(9);
    const google_map_url = $('#edit_google_map_url').val();
    const tel = $('#edit_tel').val();
    const email = $('#edit_email').val();
    const data = {
        name: name,
        area: area,
        address: address,
        lat: lat,
        lng: lng,
        google_map_url: google_map_url,
        tel: tel,
        email: email
    };
    const _method = (action == 'edit') ? 'put' : 'post';
    const _url = (action == 'edit') ? ('/api/restaurant/' + id)  : '/api/restaurant/create';
    // console.log(data, _method, _url);
    ajax(_method, _url, data, function(a){
        if (!a.message)
        {
            $('#_modal').modal('hide');
            TableList.ajax.reload();
            get_restaurant_details(a);
        }
    });
});

$(document).on('click', '.delete-btn', function(){
    const id = $(this).data('id');
    ajax('delete', '/api/restaurant/' + id, {}, function(a){
        if (!a.message)
        {
            $('#_modal').modal('hide');
            TableList.ajax.reload();
        }
    });
});

$(document).on('click', '#add-meal-btn', function(){
    $('.form-control').val('');
    $('.save-meals-btn').data('action', 'add');
    $('#meals-modal').modal({
        backdrop: 'static',
        keyboard: true,
        show: true
    });
});

$(document).on('click', '.edit-meal-btn', function(){
    const id = $(this).data('id');
    get_meal_detail(id);
});

$(document).on('click', '.save-meals-btn', function(){
    const name = $('#meal_name').val();
    const price = $('#meal_price').val();
    const category = $('#meal_category').val();
    const calorie = $('#meal_calorie').val();
    const description = $('#meal_description').val();
    const data = {
        name: name,
        price: price,
        category: category,
        calorie: calorie,
        description: description,
        restaurant_id: $('.save-btn').data('id')
    };
    const _method = ($(this).data('action') == 'add') ? 'post' : 'put';
    const _url = ($(this).data('action') == 'add') ? '/api/meals/create' : ('/api/meals/' + $(this).data('id'));
    ajax(_method, _url, data, function(a){
        if (!a.message)
        {
            $('#meals-modal').modal('hide');
            get_restaurant_details($('.save-btn').data('id'));
            TableList.ajax.reload();
        }
    });
}); 

$(document).on('click', '.del-meal-btn', function(){
    const id = $(this).data('id');
    ajax('delete', '/api/meals/' + id, {}, function(a){
        if (!a.message)
        {
            get_restaurant_details($('.save-btn').data('id'));
            TableList.ajax.reload();
        }
    });
});