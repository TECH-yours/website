let orders = [];

function get_orders()
{
    ajax('GET', '/api/orders', {}, function(data) {
        const role = localStorage.getItem('role');
        $('#order').empty();
        if (data.orders.length == 0)
        {
            $('#order').append(`
                <tr>
                    <td class="align-middle  text-center" colspan="6">目前沒有訂單</td>
                </tr>
            `);
        }
        for(const i in data.orders)
        {
            orders = data.orders;
            const _this = data.orders[i];
            let account = _this.account;
            if (!_this.account)
            {
                account = `<div class="input-group">
                                <input id="account" type="text" class="form-control" placeholder="00000" aria-label="00000" aria-describedby="button-addon2">
                                <button class="btn btn-primary" type="button" id="account_btn" data-id="${_this.id}" >回傳</button>
                            </div>`;
            }
            $('#order').append(`
                <tr>
                    <td class="align-middle  text-center">${_this.id}</td>
                    <td class="align-middle  text-center">${moment(_this.created_at).format('YYYY-MM-DD')}</td>
                    <td class="align-middle text-center">${_this.status}</td>
                    <td class="align-middle text-center">${account}</td>
                    <td class="align-middle text-center">${_this.total}</td>
                    <td class="align-middle  text-center">
                        <button class="btn btn-primary btn-sm btn-detail" data-toggle="modal" data-id="${_this.id}">詳細</button>
                    </td>
                </tr>
                `);
        }
    });
}

$(document).ready(function()
{
    $('.nav_link').removeClass('active');
    $('#nav_order').addClass('active');
    
    get_orders();

    $(document).on('click', '#account_btn', function()
    {
        const id = $(this).data('id');
        const val = $('#account').val();
        if (val.length != 5)
        {
            $.growl.warning({ message: '請輸入帳號後五碼' });
            return;
        }
        else
        {
            ajax('PUT', '/api/orders/' + id, {account: val}, function(data){
                if (!data.error)
                {
                    get_orders();
                    $.growl.notice({ message: '已回傳成功' });
                }
            });
        }
    });

    $(document).on('click', '.btn-detail', function(){
        const id = $(this).data('id');
        const order = orders.find(x => x.id == id);
        const products = order.products;
        $('#orderDetail').empty();
        for(const i in products)
        {
            const _this = products[i];
            $('#orderDetail').append(`
                <tr>
                <td class="align-middle text-center">${_this.detail.display_name}</td>
                    <td class="align-middle text-center">${_this.detail.price}</td>
                    <td class="align-middle text-center">${_this.quantity}</td>
                </tr>
            `);
        }

        const coupons = order.coupons;
        for (const i in coupons)
        {
            const _this = coupons[i];
            $('#used_coupon').append(`
                <tr>
                    <td class="align-middle text-center">${_this.code}</td>
                    <td class="align-middle text-center">滿${_this.minimum_purchase_amount}折${_this.discount_amount}</td>
                    <td class="align-middle text-center">${_this.discount_amount}</td>
                </tr>
            `);

        }

        $('#order_id').text(order.id);
        $('#order_total').text(order.total);
        $('#order_status').text(order.status);
        $('#order_account').text(order.account);
        $('#order_date').text(moment(order.created_at).format('YYYY-MM-DD'));

        $('#order_name').text(order.name);
        $('#order_phone').text(order.phone);
        $('#order_address').text(order.address);
        $('#order_vat').text(order.vat);

        $('#orderDetailModal').modal('show');
    });

    $('#orderDetailModal_close').on('click', function(){
        $('#orderDetailModal').modal('hide');
    });
});