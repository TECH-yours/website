function get_wishlists()
{
    ajax('GET', '/api/wishlists', {}, function(data) {
        const role = localStorage.getItem('role');
        $('#wishlist').empty();
        if (data.wishlists.length == 0)
        {
            $('#wishlist').append(`
                <tr>
                    <td class="align-middle  text-center" colspan="6">目前沒有收藏</td>
                </tr>
            `);
        }
        for(const i in data.wishlists)
        {
            const _this = data.wishlists[i];
            const price = (role == 'user') ? parseInt(_this.product.price_membership) : parseInt(_this.product.price_vip);
            $('#wishlist').append(`
                <tr>
                    <td class="align-middle"><input type="checkbox" name="wishlist[]" value="${_this.id}" checked></td>
                    <td class="align-middle"><img src="https://placehold.co/100x100" width="100px"></td>
                    <td class="align-middle">${_this.product.name}</td>
                    <td class="align-middle">${price}<br><span style="font-size:0.7em; color: #bbb;">原價：${parseInt(_this.product.price)}</span></td>
                    <td class="align-middle"><input class="form-control quantity" type="number" name="quantity[]" data-id="${_this.id}" value="${_this.quantity}" min="1"></td>
                    <td class="align-middle text-center ">${price * _this.quantity}<br><span style="font-size:0.7em; color: #bbb;">原價：${_this.product.price * _this.quantity}</span></td>
                </tr>
            `);
        }
    });
}

$(document).ready(function()
{
    $('.nav_link').removeClass('active');
    $('#nav_wishlist').addClass('active');
    
    get_wishlists();


    $(document).on('change', '.quantity', function(){
        const id = $(this).data('id');
        const quantity = $(this).val();
        ajax('PUT', '/api/wishlists/' + id, {quantity: quantity}, function(data){
            get_wishlists();
        });
    });

    $('#order').on('click', function()
    {
        let data = {};
        data['products'] = [];
        $('input[name="wishlist[]"]:checked').each(function()
        {
            data.products.push({
                'product_id': $(this).val(),
                'quantity': $('input[name="quantity[]"]').val()
            });
        });
        if (Object.keys(data.products).length == 0)
        {
            $.growl.warning({ message: '請至少勾選一項產品' });
            return;
        }
        // data.products = JSON.stringify(data.products);
        ajax('POST', '/api/cart/patch', data, function(a){
            if (!a.error)
            {
                $.growl.notice({ message: '已加入購物車，立即前往結帳' });
                setTimeout(() => {
                    window.location.href = '/cart';
                }, 1000);
            }
            else
            {
                $.growl.error({ message: a.error.message });
            }
        });
    });
});